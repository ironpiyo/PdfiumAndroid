name: Build PDFium for Android (All ABIs)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 40

    env:
      BUILD_ARCHS: "arm arm64 x86 x64"

    steps:
      - name: ğŸ”„ Checkout this repo
        uses: actions/checkout@v3

      - name: ğŸ“¢ Install system dependencies
        run: |
          echo "ğŸ“¦ Installing build tools..."
          sudo apt-get update
          sudo apt-get install -y git curl python3 python3-pip unzip zip openjdk-11-jdk \
              ninja-build build-essential pkg-config libglib2.0-dev

      - name: â¬‡ï¸ Clone depot_tools
        run: |
          echo "â¬‡ï¸ Cloning depot_tools..."
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$GITHUB_WORKSPACE/depot_tools" >> $GITHUB_PATH
          echo "âœ… depot_tools added to PATH."

      - name: â˜ï¸ Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@main
        with:
          ndk-version: r29-beta1

      - name: ğŸ“ Fetch PDFium source
        run: |
          echo "ğŸ“¥ Fetching PDFium..."
          fetch --nohooks pdfium
          cd pdfium
          git checkout main
          echo "âœ… Checked out PDFium main branch."

      - name: ğŸ“ Configure gclient for Android
        run: |
          echo "ğŸ›  Writing target_os to .gclient..."
          echo 'target_os = ["android"]' >> .gclient
          cd pdfium
          echo "ğŸ”„ Running gclient sync..."
          gclient sync
          echo "âœ… gclient sync complete."

      - name: ğŸ”§ Build PDFium for all ABIs
        run: |
          echo "ğŸ”§ Starting build for all ABIs..."
          for ARCH in $BUILD_ARCHS; do
            echo "----------------------------------------"
            echo "ğŸš€ Building for ABI: $ARCH"
            cd pdfium

            BUILD_DIR="out/android_${ARCH}_release"
            echo "ğŸ“ Creating build directory: $BUILD_DIR"
            mkdir -p "$BUILD_DIR"

            echo "âš™ï¸ Generating GN config for $ARCH..."
            gn gen "$BUILD_DIR" --args='
              target_os="android"
              target_cpu="'$ARCH'"
              is_debug=false
              pdf_is_standalone=true
              is_component_build=true
              pdf_enable_v8=false
              pdf_enable_xfa=false
              use_goma=false
              symbol_level=0
              use_custom_libcxx=true
            '

            echo "ğŸ›  Running ninja build for $ARCH..."
            ninja -C "$BUILD_DIR" pdfium

            echo "ğŸ“‚ ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­èº«:"
            ls -al "$BUILD_DIR"

            if [ ! -f "$BUILD_DIR/libpdfium.so" ]; then
              echo "âŒ ãƒ“ãƒ«ãƒ‰å¤±æ•—: $BUILD_DIR/libpdfium.so ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
              exit 1
            fi

            echo "ğŸ“¦ Zipping libpdfium.so for $ARCH..."
            zip -j "$BUILD_DIR/libpdfium-android-${ARCH}.zip" "$BUILD_DIR/libpdfium.so"

            cd ..
          done

      - name: âœ… Validate that libpdfium.so exists for all ABIs
        run: |
          echo "ğŸ” Verifying .so files..."
          for ARCH in $BUILD_ARCHS; do
            FILE="pdfium/out/android_${ARCH}_release/libpdfium.so"
            if [ -f "$FILE" ]; then
              echo "âœ… Found: $FILE"
            else
              echo "âŒ Missing: $FILE"
              exit 1
            fi
          done

      - name: ğŸ“¦ Bundle all libpdfium.so files into one zip
        run: |
          echo "ğŸ“¦ Creating combined zip for all ABIs..."
          mkdir -p bundled-libs

          for ARCH in $BUILD_ARCHS; do
            case "$ARCH" in
              arm) ABI_DIR="armeabi-v7a" ;;
              arm64) ABI_DIR="arm64-v8a" ;;
              x86) ABI_DIR="x86" ;;
              x64) ABI_DIR="x86_64" ;;
            esac

            mkdir -p "bundled-libs/$ABI_DIR"
            cp "pdfium/out/android_${ARCH}_release/libpdfium.so" "bundled-libs/$ABI_DIR/libpdfium.so"
          done

          zip -r libpdfium-android-all.zip bundled-libs
          echo "âœ… Created libpdfium-android-all.zip"

      - name: â˜ï¸ Upload bundled libpdfium for all ABIs
        uses: actions/upload-artifact@v4
        with:
          name: libpdfium-android-all
          path: libpdfium-android-all.zip

      - name: ğŸ“ Collect public headers
        run: |
          echo "ğŸ“¥ Collecting public headers from pdfium/public/..."
          mkdir -p headers
          cp -r pdfium/public/* headers/
          echo "âœ… Copied headers to ./headers/"

      - name: ğŸ“¦ Zip headers
        run: |
          echo "ğŸ“¦ Creating zip archive of headers..."
          zip -r pdfium-public-headers.zip headers
          echo "âœ… Created pdfium-public-headers.zip"

      - name: â˜ï¸ Upload PDFium public headers
        uses: actions/upload-artifact@v4
        with:
          name: pdfium-public-headers
          path: pdfium-public-headers.zip
