name: Build PDFium for Android

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 40

    env:
      ANDROID_NDK_VERSION: 29.0.13113456

    steps:
      - name: ğŸ”„ Checkout PDFium repo
        uses: actions/checkout@v3

      - name: ğŸ“¢ Install system dependencies
        run: |
          echo "ğŸ“¦ Installing build tools..."
          sudo apt-get update
          sudo apt-get install -y git curl python3 python3-pip unzip zip openjdk-11-jdk \
              ninja-build build-essential pkg-config libglib2.0-dev

      - name: â¬‡ï¸ Clone depot_tools
        run: |
          echo "â¬‡ï¸ Cloning depot_tools..."
          git clone https://chromium.googlesource.com/chromium/tools/depot_tools.git
          echo "$GITHUB_WORKSPACE/depot_tools" >> $GITHUB_PATH
          echo "âœ… depot_tools added to PATH."

      - name: âš™ï¸ Setup ANDROID_NDK (v29)
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.ANDROID_NDK_VERSION }}

      - name: ğŸ“ Fetch PDFium source
        run: |
          echo "ğŸ“¥ Fetching PDFium..."
          fetch --nohooks pdfium
          cd pdfium
          git checkout main
          echo "âœ… Checked out PDFium main branch."

      - name: ğŸ“ Configure gclient for Android
        run: |
          echo "ğŸ›  Writing target_os to .gclient..."
          echo 'target_os = ["android"]' >> .gclient
          cd pdfium
          echo "ğŸ”„ Running gclient sync..."
          gclient sync
          echo "âœ… gclient sync complete."

      - name: ğŸ”¨ Generate build config (GN)
        run: |
          echo "ğŸ“ Generating GN config..."
          cd pdfium
          BUILD_DIR=out/android_arm64_release
          gn gen $BUILD_DIR --args='
            target_os="android"
            target_cpu="arm64"
            is_debug=false
            pdf_is_standalone=true
            is_component_build=false
            pdf_enable_v8=false
            pdf_enable_xfa=false
            use_goma=false
            symbol_level=0
            strip_debug_info=false
            use_sysroot=true
            use_custom_libcxx=false
          '
          echo "âœ… GN configuration done."

      - name: ğŸš€ Build PDFium (ninja)
        run: |
          echo "ğŸ”§ Building PDFium..."
          cd pdfium
          ninja -C out/android_arm64_release pdfium
          echo "âœ… Build finished."

      - name: ğŸ“¦ Zip libpdfium.so
        run: |
          echo "ğŸ“¦ Zipping libpdfium.so..."
          cd pdfium/out/android_arm64_release
          zip libpdfium-android-arm64.zip libpdfium.so
          echo "âœ… Created libpdfium-android-arm64.zip."

      - name: â˜ï¸ Upload zipped libpdfium
        uses: actions/upload-artifact@v4
        with:
          name: libpdfium-android-arm64
          path: pdfium/out/android_arm64_release/libpdfium-android-arm64.zip
